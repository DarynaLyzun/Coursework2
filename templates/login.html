{% extends "base.html" %}

{% block title %}Enter - Velvet Weather{% endblock %}

{% block content %}
<div style="max-width: 400px; margin: 0 auto; text-align: center; padding-top: 10vh;">
    <h1 class="font-glam text-6xl mb-4">ENTER</h1>
    <p class="text-xs uppercase tracking-widest text-gray mb-8">Waitin' for the man</p>

    <form id="auth-form" class="card" style="padding: 2rem; text-align: left;">
        <div class="mb-4">
            <label class="text-xs uppercase tracking-widest text-gray">Email</label>
            <input type="email" id="email" required placeholder="lou@factory.com">
        </div>
        <div class="mb-8">
            <label class="text-xs uppercase tracking-widest text-gray">Password</label>
            <input type="password" id="password" required placeholder="••••••••">
        </div>
        <div id="error-msg" style="color: red; font-size: 0.8rem; margin-bottom: 1rem; display: none;"></div>
        
        <button type="submit" class="btn-glam" style="width: 100%;">Sign In</button>
        <button type="button" id="toggle-mode" style="background:none; color:#888; border:none; width:100%; margin-top:1rem; cursor:pointer; font-size:0.7rem; text-transform:uppercase; letter-spacing:0.1em;">
            Need an account?
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isLogin = true;
    const form = document.getElementById('auth-form');
    const toggleBtn = document.getElementById('toggle-mode');
    const submitBtn = form.querySelector('button[type="submit"]');

    toggleBtn.addEventListener('click', () => {
        isLogin = !isLogin;
        document.querySelector('h1').textContent = isLogin ? 'ENTER' : 'JOIN';
        submitBtn.textContent = isLogin ? 'Sign In' : 'Sign Up';
        toggleBtn.textContent = isLogin ? 'Need an account?' : 'Already have one?';
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('error-msg');
        
        const endpoint = isLogin ? "/login" : "/signup";
        const headers = isLogin 
            ? { "Content-Type": "application/x-www-form-urlencoded" }
            : { "Content-Type": "application/json" };
            
        const body = isLogin 
            ? new URLSearchParams({ username: email, password: password }) 
            : JSON.stringify({ email, password });

        try {
            const res = await fetch(endpoint, { method: "POST", headers, body });
            const data = await res.json();

            if (!res.ok) throw new Error(data.detail || "Error");

            if (isLogin) {
                setToken(data.access_token);
                window.location.href = '/';
            } else {
                isLogin = true;
                alert("Registered. Please log in.");
                window.location.reload();
            }
        } catch (err) {
            errorDiv.textContent = err.message;
            errorDiv.style.display = 'block';
        }
    });
</script>
{% endblock %}